name: Reusable Deploy to GCP VM (PM2)

on:
  workflow_call:
    inputs:
      WORKLOAD_IDENTITY_PROVIDER:
        description: Full WIF provider resource name
        required: true
        type: string
      GCP_SERVICE_ACCOUNT:
        description: Service Account email for WIF
        required: true
        type: string
      GCP_PROJECT_ID:
        description: GCP Project ID
        required: true
        type: string
      GCP_ZONE:
        description: GCE zone of the VM
        required: true
        type: string
      GCP_INSTANCE:
        description: GCE instance name
        required: true
        type: string
      APP_NAME:
        description: Application slug (used in paths and PM2 name)
        required: true
        type: string
      APP_DOMAIN:
        description: FQDN to serve
        required: true
        type: string
      LB_PUBLIC_IP:
        description: Load balancer public IP for DNS A record
        required: true
        type: string
      CF_ZONE_ID:
        description: Cloudflare Zone ID
        required: true
        type: string
      NODE_ENV:
        description: Node environment (default production)
        required: false
        default: production
        type: string
    secrets:
      CF_API_TOKEN:
        description: Cloudflare API token with DNS:Edit
        required: true


jobs:
  deploy:
    permissions:
      id-token: none
      contents: read
      
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      WORKLOAD_IDENTITY_PROVIDER: ${{ inputs.WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ inputs.GCP_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ inputs.GCP_PROJECT_ID }}
      GCP_ZONE: ${{ inputs.GCP_ZONE }}
      GCP_INSTANCE: ${{ inputs.GCP_INSTANCE }}
      APP_NAME: ${{ inputs.APP_NAME }}
      APP_DOMAIN: ${{ inputs.APP_DOMAIN }}
      LB_PUBLIC_IP: ${{ inputs.LB_PUBLIC_IP }}
      CF_ZONE_ID: ${{ inputs.CF_ZONE_ID }}
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      NODE_ENV: ${{ inputs.NODE_ENV }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'beta'

      - name: Ensure app dir on VM
        run: |
          set -euo pipefail
          gcloud compute ssh ${env.GCP_INSTANCE} \
            --project ${env.GCP_PROJECT_ID} \
            --zone ${env.GCP_ZONE} \
            --tunnel-through-iap \
            --command "sudo mkdir -p /var/www/${env.APP_NAME}/current && sudo chown -R \"$USER:$USER\" /var/www/${env.APP_NAME}"

      - name: Upload source to VM via IAP Tunnel
        run: |
          set -euo pipefail
          gcloud compute scp --recurse --quiet \
            . ${env.GCP_INSTANCE}:/var/www/${env.APP_NAME}/current \
            --project ${env.GCP_PROJECT_ID} \
            --zone ${env.GCP_ZONE} \
            --tunnel-through-iap

      - name: Deploy via PM2 script on VM (IAP)
        run: |
          set -euo pipefail
          gcloud compute ssh ${env.GCP_INSTANCE} \
            --project ${env.GCP_PROJECT_ID} \
            --zone ${env.GCP_ZONE} \
            --tunnel-through-iap \
            --command "sudo /usr/local/bin/deploy_app_pm2.sh '${{ env.APP_NAME }}' '${{ env.APP_DOMAIN }}' '${{ env.NODE_ENV }}'"

      - name: Upsert Cloudflare A record
        env:
          CF_API_TOKEN: ${{ env.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ env.CF_ZONE_ID }}
          APP_DOMAIN: ${{ env.APP_DOMAIN }}
          LB_PUBLIC_IP: ${{ env.LB_PUBLIC_IP }}
        run: |
          set -euo pipefail
          API="https://api.cloudflare.com/client/v4"
          HDRS=(-H "Content-Type: application/json" -H "Authorization: Bearer ${CF_API_TOKEN}")
          rec_id="$(curl -fsS "${API}/zones/${CF_ZONE_ID}/dns_records?type=A&name=${APP_DOMAIN}" "${HDRS[@]}" | jq -r '.result[0].id // empty')"
          data="$(jq -n --arg name "${APP_DOMAIN}" --arg ip "${LB_PUBLIC_IP}" '{type:"A", name:$name, content:$ip, ttl:120, proxied:true}')"
          if [[ -n "${rec_id}" ]]; then
            curl -fsS -X PUT "${API}/zones/${CF_ZONE_ID}/dns_records/${rec_id}" "${HDRS[@]}" --data "${data}" >/dev/null
            echo "Updated A record ${APP_DOMAIN} -> ${LB_PUBLIC_IP}"
          else
            curl -fsS -X POST "${API}/zones/${CF_ZONE_ID}/dns_records" "${HDRS[@]}" --data "${data}" >/dev/null
            echo "Created A record ${APP_DOMAIN} -> ${LB_PUBLIC_IP}"
          fi


